!function(e){e.widget("ra.filteringSelect",{options:{createQuery:function(e){return{query:e}},minLength:0,searchDelay:200,remote_source:null,source:null,xhr:!1},_create:function(){var t=this,i=this.element.hide(),o=i.children(":selected"),n=o.val()?o.text():"";this.options.source=this.options.xhr?this.options.remote_source:i.children("option").map(function(){return{label:e(this).text(),value:this.value}}).toArray();var l=e('<div class="input-append filtering-select" style="float:left"></div>'),a=this.input=e('<input type="text">').val(n).addClass("ra-filtering-select-input").attr("style",i.attr("style")).show().autocomplete({delay:this.options.searchDelay,minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(o,n){var l=e('<option value="'+n.item.id+'" selected="selected">'+n.item.value+"</option>");i.html(l),i.trigger("change",n.item.id),t._trigger("selected",o,{item:l}),e(t.element.parents(".controls")[0]).find(".update").removeClass("disabled")},change:function(o,n){if(!n.item){var l=new RegExp("^"+e.ui.autocomplete.escapeRegex(e(this).val())+"$","i"),s=!1;if(i.children("option").each(function(){return e(this).text().match(l)?(this.selected=s=!0,!1):void 0}),!s||""==e(this).val())return e(this).val(null),i.html(e('<option value="" selected="selected"></option>')),a.data("autocomplete").term="",e(t.element.parents(".controls")[0]).find(".update").addClass("disabled"),!1}}}).keyup(function(){0==e(this).val().length&&(i.html(e('<option value="" selected="selected"></option>')),i.trigger("change"))});i.attr("placeholder")&&a.attr("placeholder",i.attr("placeholder")),a.data("autocomplete")._renderItem=function(t,i){return e("<li></li>").data("item.autocomplete",i).append(e("<a></a>").html(i.label||i.id)).appendTo(t)};var s=this.button=e('<label class="add-on ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" title="Show All Items" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-triangle-1-s"></span><span class="ui-button-text">&nbsp;</span></label>').click(function(){return a.autocomplete("widget").is(":visible")?(a.autocomplete("close"),void 0):(a.autocomplete("search",""),a.focus(),void 0)});l.append(a).append(s).insertAfter(i)},_getResultSet:function(t,i,o){var n=new RegExp(e.ui.autocomplete.escapeRegex(t.term),"i");return e.map(i,function(i){return(i.id||i.value)&&(o||n.test(i.label))?{label:i.label?i.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.ui.autocomplete.escapeRegex(t.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):i.id,value:i.label||i.id,id:i.id||i.value}:void 0})},_getSourceFunction:function(t){var i=this,o=0;return e.isArray(t)?function(e,o){o(i._getResultSet(e,t,!1))}:"string"==typeof t?function(n,l){this.xhr&&this.xhr.abort(),this.xhr=e.ajax({url:t,data:i.options.createQuery(n.term),dataType:"json",autocompleteRequest:++o,success:function(e){this.autocompleteRequest===o&&l(i._getResultSet(n,e,!0))},error:function(){this.autocompleteRequest===o&&l([])}})}:t},destroy:function(){this.input.remove(),this.button.remove(),this.element.show(),e.Widget.prototype.destroy.call(this)}})}(jQuery);